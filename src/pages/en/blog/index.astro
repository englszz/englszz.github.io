---
import { type LanguageCode } from '@/i18n/ui';
import { AllBlogPostsScreen } from '@/features/blog';
import { getCollection, render, type CollectionEntry } from 'astro:content';

// Obtiene el idioma de la URL actual. Si no tiene prefijo, usa 'en' (que es tu español)
const lang = (Astro.currentLocale ?? 'en') as LanguageCode;

const blogEntries: Array<CollectionEntry<'blog'>> = await getCollection(
  'blog',
  ({ data, id }) => {
    // ✅ Lógica Corregida: Ahora filtramos por la clave de idioma (data.lang) que tienes
    // en tus logros, asegurando que solo se muestren los logros que coincidan
    // con el idioma de la página (ej: '/en/blog' solo muestra 'lang: en').
    return data.isDraft !== true && data.lang === lang; 
  }
);

const enrichedPosts = await Promise.all(
  blogEntries.map(async (postEntry: CollectionEntry<'blog'>) => {
    const { remarkPluginFrontmatter } = await render(postEntry);
    return {
      id: postEntry.id,
      slug: postEntry.id,
      collection: postEntry.collection,
      data: {
        ...postEntry.data,
        readingTimeMinutes: remarkPluginFrontmatter.readingTimeMinutes,
      },
    };
  })
);

enrichedPosts.sort(
  (a, b) =>
    new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);
---

<AllBlogPostsScreen posts={enrichedPosts} lang={lang} />